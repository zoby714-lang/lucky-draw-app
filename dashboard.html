<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÚˆÛŒÙ„ÛŒ Ù‚Ø±Ø¹Û â€“ ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ</title>

  <!-- Ø¢Ù¾ Ú©ÛŒ Ù…ÙˆØ¬ÙˆØ¯Û Ú¯Ù„ÙˆØ¨Ù„ Ø§Ø³Ù¹Ø§Ø¦Ù„ -->
  <link rel="stylesheet" href="style.css">

  <!-- Firebase App init (Ø¢Ù¾ Ú©ÛŒ Ù…ÙˆØ¬ÙˆØ¯Û ÙØ§Ø¦Ù„) -->
  <script type="module" src="firebase-config.js"></script>

  <!-- Minimal inline styles (ØµØ±Ù Ø§Ø³ Ù¾ÛŒØ¬ Ú©Û’ Ù†Ø¦Û’ Ø³ÛŒÚ©Ø´Ù†Ø² Ú©Û’ Ù„ÛŒÛ’) -->
  <style>
    .wrap {max-width: 980px; margin: 0 auto; padding: 16px;}
    header.dh {display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px;}
    .brand {display:flex; gap:12px; align-items:center;}
    .brand h1 {font-size:1.25rem; margin:0;}
    .chip {display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:.9rem;}
    .chip.ok {background:#0e7e6b; color:#fff;}
    .chip.bad {background:#6b2230; color:#fff;}
    .card {background:#2f2f48; border-radius:14px; padding:16px; margin:12px 0;}
    .card h2 {margin:0 0 8px 0; font-size:1.1rem; color:#00c9a7;}
    .grid {display:grid; grid-template-columns:1fr; gap:12px;}
    @media (min-width: 720px){ .grid{grid-template-columns:1fr 1fr;} }
    .btn {background:#00c9a7; color:#0d0d19; padding:10px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:600;}
    .btn[disabled]{opacity:.6; cursor:not-allowed;}
    .muted {opacity:.8; font-size:.95rem;}
    .list {margin:0; padding:0; list-style:none;}
    .list li {display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #444; padding:10px 0;}
    .kpi {display:flex; gap:16px; flex-wrap:wrap;}
    .kpi .box {background:#383856; border-radius:10px; padding:10px 14px; min-width:160px;}
    .note {background:#383856; padding:10px 12px; border-radius:10px; font-size:.95rem;}
    .warn {color:#ffd166;}
    .oktxt {color:#00e5bf;}
    .small {font-size:.9rem;}
    .rule-list {margin:8px 0 0 0; padding-inline-start:20px;}
    .rule-list li {margin:6px 0;}
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Header -->
    <header class="dh">
      <div class="brand">
        <img src="logo.png" alt="logo" onerror="this.style.display='none'" width="36" height="36">
        <div>
          <h1>ÚˆÛŒÙ„ÛŒ Ù‚Ø±Ø¹Û â€” Ú©Ù…ÛŒÙ¹ÛŒ Ø§ÛŒÙ¾</h1>
          <div id="userEmail" class="muted small">Ø¢Ù¾ Ú©Ø§ Ø§Ú©Ø§Ø¤Ù†Ù¹ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’â€¦</div>
        </div>
      </div>
      <button id="logoutBtn" class="btn">Ù„Ø§Ú¯ Ø¢Ø¤Ù¹</button>
    </header>

    <!-- Status / KPIs -->
    <div class="card">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between;">
        <div id="windowChip" class="chip bad">ğŸš« Ø§Ù†ÙˆÛŒØ³Ù¹Ù…Ù†Ù¹ ÙˆÙ†ÚˆÙˆ Ø¨Ù†Ø¯</div>
        <div class="kpi">
          <div class="box">
            <div class="small muted">Ù‚Ø±Ø¹Û Ø§Ù†Ø¯Ø§Ø²ÛŒ ØªÚ© ÙˆÙ‚Øª</div>
            <div id="drawCountdown" style="font-weight:700; font-size:1.2rem">--:--:--</div>
          </div>
          <div class="box">
            <div class="small muted">Ø¢Ø¬ Ú©ÛŒ Ø¢Ù¾ Ú©ÛŒ Ø§Ù†Ù¹Ø±ÛŒØ²</div>
            <div><span id="todayCount" style="font-weight:700; font-size:1.2rem">0</span> / 10</div>
          </div>
        </div>
      </div>
      <div class="note" style="margin-top:10px">
        â° Ø§Ù†ÙˆÛŒØ³Ù¹Ù…Ù†Ù¹ Ù¹Ø§Ø¦Ù…: <b>Ø±Ø§Øª 10:00 (PKT)</b> Ø³Û’ <b>Ø´Ø§Ù… 6:00 (PKT)</b> ØªÚ© â€” Ù‚Ø±Ø¹Û Ø§Ù†Ø¯Ø§Ø²ÛŒ <b>Ø´Ø§Ù… 8:00 (PKT)</b>Û”
      </div>
    </div>

    <!-- Actions + Entries -->
    <div class="grid">
      <div class="card">
        <h2>â• Ú©Ù…ÛŒÙ¹ÛŒ Ø§Ù†Ù¹Ø±ÛŒ (â‚¨ 200)</h2>
        <p class="muted small">
          Ø§Ø³ ÙˆÙ‚Øª Ø¢Ù¾ <b>Ø±ÙˆØ²Ø§Ù†Û Ø²ÛŒØ§Ø¯Û Ø³Û’ Ø²ÛŒØ§Ø¯Û 10</b> Ø§Ù†Ù¹Ø±ÛŒØ² ÚˆØ§Ù„ Ø³Ú©ØªÛ’ ÛÛŒÚºÛ” Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ ÙÛŒ Ø§Ù„Ø­Ø§Ù„ Ø¢Ù Ù„Ø§Ø¦Ù† ØªØµØ¯ÛŒÙ‚ Ú©Û’ Ø¨Ø¹Ø¯ ÙØ¹Ø§Ù„ ÛÙˆÚ¯ÛŒÛ”
        </p>
        <button id="addEntryBtn" class="btn">Ø§Ù†Ù¹Ø±ÛŒ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº (â‚¨200)</button>
        <div id="entryMsg" class="small" style="margin-top:8px;"></div>
        <div class="note" style="margin-top:10px">
          â„¹ï¸ Ø§Ù†Ù¹Ø±ÛŒ Ø´Ø§Ù…Ù„ Ú©Ø±Ù†Û’ Ù¾Ø± Ø§Ø³ Ú©ÛŒ Ø­Ø§Ù„Øª <b>â€œVerification pendingâ€</b> ÛÙˆÚ¯ÛŒÛ” ØªØµØ¯ÛŒÙ‚ Ú©Û’ Ø¨Ø¹Ø¯ Ø¢Ù¾ Ú©Û’ ÙˆØ§Ù„Ù¹/Ø§Ú©Ø§Ø¤Ù†Ù¹ Ù…ÛŒÚº Ø¸Ø§ÛØ± ÛÙˆÚ¯ÛŒÛ”
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“ƒ Ø¢Ø¬ Ú©ÛŒ Ø¢Ù¾ Ú©ÛŒ Ø§Ù†Ù¹Ø±ÛŒØ²</h2>
        <ul id="entryList" class="list">
          <li class="muted"><span>Ø±ÛŒÚ©Ø§Ø±Úˆ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’â€¦</span><span>â€”</span></li>
        </ul>
      </div>
    </div>

    <!-- Rules -->
    <div class="card">
      <h2>ğŸ“Œ Ø§ØµÙˆÙ„ Ùˆ Ø¶ÙˆØ§Ø¨Ø·</h2>
      <ul class="rule-list">
        <li>Ø§Ù†ÙˆÛŒØ³Ù¹Ù…Ù†Ù¹ ÙˆÙ†ÚˆÙˆ: <b>10PM â†’ 6PM (PKT)</b>Û”</li>
        <li>Ù‚Ø±Ø¹Û Ø§Ù†Ø¯Ø§Ø²ÛŒ: <b>Ø±ÙˆØ²Ø§Ù†Û 8PM (PKT)</b> â€” Ø§ÛŒÙ¾ Ù…ÛŒÚº Ù„Ø§Ø¦ÛŒÙˆ Ø¯ÛŒÚ©Ú¾Ø§ Ø¬Ø§ Ø³Ú©Û’ Ú¯Ø§ (Ù¾Ù„ÛŒØ³ ÛÙˆÙ„ÚˆØ± Ø§Ø³Ù¹ÛŒØ¬)Û”</li>
        <li>Ú©Ù… Ø§Ø² Ú©Ù… Ú©Ù…ÛŒÙ¹ÛŒ: <b>â‚¨200</b> (Ø§ÛŒÚ© Ø§Ù†Ù¹Ø±ÛŒ = â‚¨200)Û”</li>
        <li>ÙÛŒ ÛŒÙˆØ²Ø± Ø±ÙˆØ²Ø§Ù†Û Ø²ÛŒØ§Ø¯Û Ø³Û’ Ø²ÛŒØ§Ø¯Û <b>10</b> Ø§Ù†Ù¹Ø±ÛŒØ²Û”</li>
        <li>ÙˆÙ†Ø±Ø² Ú©ÛŒ Ù„Ø³Ù¹ Ù…ÛŒÚº Ù†Ø§Ù…/Ù†Ù…Ø¨Ø± Ù…Ø§Ø³Ú© ÛÙˆ Ú©Ø± Ø¸Ø§ÛØ± ÛÙˆÚº Ú¯Û’Û”</li>
        <li>ÛØ± ÙˆØ¯ÚˆØ±Ø§ Ù¾Ø± <b>10%</b> Ø³Ø±ÙˆØ³ ÙÛŒØ³ Ù„Ø§Ú¯Ùˆ ÛÙˆÚ¯ÛŒÛ”</li>
      </ul>
    </div>

    <!-- Winners (Placeholder) -->
    <div class="card">
      <h2>ğŸ† Ø¢Ø¬ Ú©Û’ ÙˆÙ†Ø±Ø²</h2>
      <p class="muted">8PM Ù¾Ø± Ù„Ø§Ø¦ÛŒÙˆ ÚˆØ±Ø§ Ú©Û’ Ø¨Ø¹Ø¯ ÛŒÛØ§Úº Ù†ØªØ§Ø¦Ø¬ Ø¸Ø§ÛØ± ÛÙˆ Ø¬Ø§Ø¦ÛŒÚº Ú¯Û’Û”</p>
      <ul id="winnersList" class="list"></ul>
    </div>
  </div>

  <!-- Logic -->
  <script type="module">
    // Firebase SDKs (same major version as your firebase-config.js)
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, get, set, push, serverTimestamp, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // Ø§Ú¯Ø± firebase-config.js Ù…ÛŒÚº initializeApp ÛÙˆ Ú†Ú©Ø§ ÛÛ’ ØªÙˆ default app available ÛÛ’
    const auth = getAuth();
    const db = getDatabase();

    // DOM refs
    const userEmailEl = document.getElementById("userEmail");
    const windowChip = document.getElementById("windowChip");
    const drawCountdownEl = document.getElementById("drawCountdown");
    const todayCountEl = document.getElementById("todayCount");
    const addEntryBtn = document.getElementById("addEntryBtn");
    const entryMsg = document.getElementById("entryMsg");
    const entryList = document.getElementById("entryList");
    const logoutBtn = document.getElementById("logoutBtn");

    // --- Time helpers (Pakistan time) ---
    function nowInPK() {
      // convert current UTC â†’ Asia/Karachi (UTC+5, no DST)
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      return new Date(utc + (5 * 60 * 60 * 1000));
    }
    function pkDateStr(d = nowInPK()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const da = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${da}`;
    }
    function depositWindowOpen(d = nowInPK()) {
      const h = d.getHours(); // 0..23 in PKT
      // Open from 22:00 â†’ 23:59 and 00:00 â†’ 17:59 (i.e., h>=22 OR h<18)
      return (h >= 22 || h < 18);
    }
    function nextDrawTarget(d = nowInPK()) {
      const t = new Date(d);
      t.setHours(20,0,0,0); // 20:00 PKT today
      if (d.getTime() >= t.getTime()) {
        // move to tomorrow 20:00
        t.setDate(t.getDate() + 1);
      }
      return t;
    }
    function startDrawCountdown() {
      function tick() {
        const dNow = nowInPK();
        const target = nextDrawTarget(dNow);
        const diff = target - dNow;
        if (diff <= 0) {
          drawCountdownEl.textContent = "00:00:00";
          return;
        }
        const s = Math.floor(diff/1000);
        const hh = String(Math.floor(s/3600)).padStart(2, "0");
        const mm = String(Math.floor((s%3600)/60)).padStart(2, "0");
        const ss = String(s%60).padStart(2, "0");
        drawCountdownEl.textContent = `${hh}:${mm}:${ss}`;
      }
      tick();
      setInterval(tick, 1000);
    }

    // --- UI status refresh ---
    function refreshWindowChip() {
      if (depositWindowOpen()) {
        windowChip.classList.remove("bad");
        windowChip.classList.add("ok");
        windowChip.textContent = "âœ… Ø§Ù†ÙˆÛŒØ³Ù¹Ù…Ù†Ù¹ ÙˆÙ†ÚˆÙˆ Ú©Ú¾Ù„ÛŒ ÛÛ’";
        addEntryBtn.disabled = false;
      } else {
        windowChip.classList.remove("ok");
        windowChip.classList.add("bad");
        windowChip.textContent = "ğŸš« Ø§Ù†ÙˆÛŒØ³Ù¹Ù…Ù†Ù¹ ÙˆÙ†ÚˆÙˆ Ø¨Ù†Ø¯";
        addEntryBtn.disabled = true;
      }
    }

    // --- Load today's entries for user ---
    async function loadEntries(uid) {
      const today = pkDateStr();
      const entriesRef = ref(db, `users/${uid}/entries/${today}`);
      onValue(entriesRef, (snap) => {
        const val = snap.val();
        entryList.innerHTML = "";
        let count = 0;
        if (val) {
          Object.keys(val).forEach((k) => {
            const e = val[k];
            count++;
            const li = document.createElement("li");
            const when = e.localTime || "â€”";
            const status = e.status || "pending";
            li.innerHTML = `<span>Ø§Ù†Ù¹Ø±ÛŒ #${count} â€” â‚¨${e.amount || 200} <span class="muted small">(${when})</span></span>
                            <span class="small ${status==='pending_verification'?'warn':'oktxt'}">${status.replace('_',' ')}</span>`;
            entryList.appendChild(li);
          });
        } else {
          const li = document.createElement("li");
          li.className = "muted";
          li.innerHTML = "<span>Ø¢Ø¬ Ø§Ø¨Ú¾ÛŒ Ú©ÙˆØ¦ÛŒ Ø§Ù†Ù¹Ø±ÛŒ Ù†ÛÛŒÚºÛ”</span><span>â€”</span>";
          entryList.appendChild(li);
        }
        todayCountEl.textContent = String(count);
        // limit 10
        addEntryBtn.disabled = !depositWindowOpen() || count >= 10;
      });
    }

    // --- Add entry (â‚¨200) ---
    async function addEntry(uid) {
      entryMsg.textContent = "";
      if (!depositWindowOpen()) {
        entryMsg.innerHTML = "â›” Ø§Ø³ ÙˆÙ‚Øª Ø§Ù†ÙˆÛŒØ³Ù¹Ù…Ù†Ù¹ ÙˆÙ†ÚˆÙˆ Ø¨Ù†Ø¯ ÛÛ’Û” 10PMâ€“6PM Ú©Û’ Ø¯Ø±Ù…ÛŒØ§Ù† Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”";
        return;
      }
      // check count
      const today = pkDateStr();
      const entriesRef = ref(db, `users/${uid}/entries/${today}`);
      const snap = await get(entriesRef);
      const count = snap.exists() ? Object.keys(snap.val()).length : 0;
      if (count >= 10) {
        entryMsg.innerHTML = "âš ï¸ Ø¢Ø¬ Ø¢Ù¾ 10 Ø§Ù†Ù¹Ø±ÛŒØ² Ù…Ú©Ù…Ù„ Ú©Ø± Ú†Ú©Û’ ÛÛŒÚºÛ”";
        return;
      }

      const localTime = nowInPK().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
      const newRef = push(entriesRef);
      await set(newRef, {
        amount: 200,
        status: "pending_verification",
        createdAt: serverTimestamp(),
        localTime
      });

      entryMsg.innerHTML = "âœ… Ø§Ù†Ù¹Ø±ÛŒ Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯Ø¦ÛŒÛ” <b>Verification pending</b> â€” Ø§Ø¯Ø§Ø¦ÛŒÚ¯ÛŒ Ù„Ù†Ú© ØªØµØ¯ÛŒÙ‚ Ú©Û’ Ø¨Ø¹Ø¯ ÙØ¹Ø§Ù„ ÛÙˆÚ¯Ø§Û”";
    }

    // --- Auth state ---
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "signin.html";
        return;
      }
      userEmailEl.textContent = `Ù„Ø§Ú¯ Ø§ÙÙ†: ${user.email}`;
      refreshWindowChip();
      startDrawCountdown();
      loadEntries(user.uid);
    });

    // events
    addEntryBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      await addEntry(user.uid);
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => location.href = "signin.html");
    });

    // keep window chip live
    setInterval(refreshWindowChip, 30 * 1000);
  </script>
</body>
</html>
